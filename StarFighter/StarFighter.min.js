"use strict";var V=function(e,i,t){return new BABYLON.Vector3(+e,+i,+t)},randomSign=function(){return Math.random()-.5<0?-1:1},SF={};SF.Assets={flareURL:"assets/flarealpha.png",sightURL:"assets/viseur.png",rustyURL:"assets/rusty.jpg",rustyNormalURL:"assets/rustyNormal.png",universeURL:"assets/stars1.jpg",planetURL:"assets/planetsheet.png",enemyURL1:"assets/enemy.jpg",enemyURL2:"assets/enemy3.jpg",enemyNormalURL1:"assets/enemyNormal.png",enemyNormalURL3:"assets/enemyNormal3.png"},SF.CreateMaterials=function(e){SF.Materials={};var i=new BABYLON.Texture(SF.Assets.flareURL,e);i.hasAlpha=!0;var t=new BABYLON.Texture(SF.Assets.sightURL,e),s=new BABYLON.Texture(SF.Assets.rustyURL,e),a=new BABYLON.Texture(SF.Assets.rustyNormalURL,e),n=new BABYLON.Texture(SF.Assets.enemyURL1,e),o=new BABYLON.Texture(SF.Assets.enemyURL2,e),h=new BABYLON.Texture(SF.Assets.enemyNormalURL1,e),r=new BABYLON.Texture(SF.Assets.enemyNormalURL3,e);o.uScale=.5,o.vScale=o.uScale,r.uScale=o.uScale,r.vScale=o.uScale;var c=new BABYLON.Texture(SF.Assets.universeURL,e);c.uScale=8,c.vScale=c.uScale;var l=new BABYLON.Texture(SF.Assets.planetURL,e),m=new BABYLON.StandardMaterial("um",e);m.alpha=.6,m.freeze(),m.emissiveTexture=c,SF.Materials.universe=m;var p=new BABYLON.StandardMaterial("um",e);p.freeze(),p.diffuseTexture=l,p.specularColor=new BABYLON.Color3(.1,.1,.1),SF.Materials.planets=p;var d=new BABYLON.StandardMaterial("sm",e);d.emissiveColor=BABYLON.Color3.White(),d.diffuseColor=BABYLON.Color3.White(),d.diffuseTexture=i,d.useAlphaFromDiffuseTexture=!0,d.freeze(),SF.Materials.star=d;var S=new BABYLON.StandardMaterial("sm",e);t.hasAlpha=!0,S.emissiveTexture=t,S.diffuseTexture=t,S.useAlphaFromDiffuseTexture=!0,S.freeze(),SF.Materials.sight=S;var g=new BABYLON.StandardMaterial("cm",e);g.diffuseTexture=s,g.bumpTexture=a,SF.Materials.ship=g;var u=new BABYLON.StandardMaterial("shm",e);u.alpha=.5,u.diffuseColor=BABYLON.Color3.Green(),SF.Materials.shield=u;var y=new BABYLON.StandardMaterial("lm",e);y.emissiveColor=BABYLON.Color3.White(),y.freeze(),SF.Materials.laser=y;var L=new BABYLON.StandardMaterial("em1",e);L.emissiveColor=new BABYLON.Color3(1,1,1),L.diffuseTexture=n,L.bumpTexture=h,L.specularPower=48,SF.Materials.enemy1=L;var x=new BABYLON.StandardMaterial("em2",e);x.emissiveColor=new BABYLON.Color3(1,1,1),x.diffuseTexture=o,x.bumpTexture=r,x.specularPower=48,SF.Materials.enemy2=x;var B=new BABYLON.StandardMaterial("im",e);B.emissiveColor=BABYLON.Color3.White(),B.diffuseColor=BABYLON.Color3.White(),B.diffuseTexture=i,B.useAlphaFromDiffuseTexture=!0,B.freeze(),SF.Materials.impact=B},SF.CreateLights=function(e){SF.Lights={};var i=new BABYLON.HemisphericLight("light",V(0,1,-.75),e);i.intensity=.8,i.shadowEnabled=!1,SF.Lights.light=i,SF.Lights.lightInitialIntensity=.8;var t=new BABYLON.PointLight("pointLight",V(0,0,0),e);t.diffuse=new BABYLON.Color3(0,0,1),t.specular=new BABYLON.Color3(.5,.5,1),t.intensity=0,t.shadowEnabled=!1,SF.Lights.pointLight=t,SF.Lights.pointLightMaxIntensity=.6;var s=new BABYLON.PointLight("explosionLight",V(0,0,0),e);s.diffuse=new BABYLON.Color3(1,1,.6),s.specular=new BABYLON.Color3(1,1,.8),s.shadowEnabled=!1,SF.Lights.explLghtIntensity=1,s.intensity=0,SF.Lights.explosionLight=s;var a=new BABYLON.HemisphericLight("light",V(randomSign()*Math.random(),Math.random(),-Math.random()),e);a.shadowEnabled=!1,SF.Lights.spaceLight=a},SF.GUI=function(e){var i=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI",!0,e);i.idealWitdh=600,i.renderAtIdealSize=!0;var t=new BABYLON.GUI.TextBlock;t.text="000000",t.color="white",t.fontSize=24,t.textVerticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,i.addControl(t),this.score=t},SF.GUI.prototype.pad=function(e,i){for(var t=String(e);t.length<(i||2);)t="0"+t;return t},SF.Universe=function(e){this.gameScene=e;var i=this.gameScene.scene,t=BABYLON.MeshBuilder.CreateIcoSphere("ico",{radius:5*this.gameScene.distance,subdivisions:4,sideOrientation:BABYLON.Mesh.BACKSIDE},i);t.material=SF.Materials.universe,t.alwaysSelectAsActiveMesh=!0,this.mesh=t},SF.Universe.prototype.animate=function(){this.mesh.rotation.x+=.01*this.gameScene.ang.x,this.mesh.rotation.y-=.01*this.gameScene.ang.y},SF.Planets=function(e,i){this.gameScene=e;var t=this.gameScene.scene,s=1.5*this.gameScene.distance,a=new BABYLON.SolidParticleSystem("plsps",t,{updatable:!1}),n=BABYLON.MeshBuilder.CreateSphere("plmdl",{diameter:10,segments:24},t);a.addShape(n,i,{positionFunction:function(e,i,t){e.position.x=randomSign()*(s+.4*Math.random()),e.position.y=randomSign()*(s+.4*Math.random()),e.position.z=randomSign()*(s+.4*Math.random()),e.rotation.y=6.28*randomSign()*Math.random(),e.rotation.z=.8*randomSign()*Math.random(),e.scaling.x=6*Math.random(),e.scaling.y=e.scaling.x,e.scaling.z=e.scaling.x,e.color=new BABYLON.Color4(.5*Math.random()+.5,.5*Math.random()+.5,.5*Math.random()+.5,1);var a=.5*Math.floor(2*Math.random()),n=.25*Math.floor(4*Math.random());e.uvs.x=a,e.uvs.y=n,e.uvs.z=a+.5,e.uvs.w=n+.25}}),a.buildMesh(),n.dispose(),a.isAlwaysVisible=!0,this.sps=a,this.mesh=a.mesh,this.mesh.material=SF.Materials.planets},SF.Planets.prototype.animate=function(){this.mesh.rotation.x+=.01*this.gameScene.ang.x,this.mesh.rotation.y-=.01*this.gameScene.ang.y,BABYLON.Quaternion.RotationYawPitchRollToRef(this.mesh.rotation.y,this.mesh.rotation.x,0,this.gameScene.quaternion),this.gameScene.quaternion.toRotationMatrix(this.gameScene.rotMatrix),BABYLON.Vector3.TransformNormalToRef(this.gameScene.initialSpaceLightDirection,this.gameScene.rotMatrix,SF.Lights.spaceLight.direction)},SF.Starship=function(e){var i=e.scene;this.gameScene=e,this.cockpitArea=this.gameScene.cockpitArea;for(var t=[],s=0;s<=40;s++){var a=s/20-1,n=-a*a*a*a*1.5+.8,o=2+n;t.push(V(a,n,o))}var h=[V(-1.5,.8,0),V(-.5,-.8,3)],r=[V(1.5,.8,0),V(.5,-.8,3)],c=BABYLON.MeshBuilder.CreateTube("t1",{path:h,radius:.03},i),l=BABYLON.MeshBuilder.CreateTube("t2",{path:r,radius:.03},i),m=BABYLON.MeshBuilder.CreateTube("t3",{path:t,radius:.03},i);this.rpath1=[],this.rpath2=[],this.rpath3=[],this.initialRpath3=[],this.cockpitHeight=this.gameScene.cockpitHeight;for(var p=0;p<=10;p++){var d=p/10;this.rpath1.push(V(-.5+d,-.05*Math.cos(p*Math.PI/5)-.75,3.1)),this.rpath2.push(V(-.5+d,-1,0)),this.rpath3.push(V(this.rpath1[p].x,this.rpath1[p].y+this.cockpitHeight,this.rpath1[p].z)),this.initialRpath3.push(V(this.rpath1[p].x,this.rpath1[p].y+this.cockpitHeight,this.rpath1[p].z))}this.rpath3[0].y=this.rpath1[0].y,this.rpath3[10].y=this.rpath1[10].y,this.initialRpath3[0].y=this.rpath3[0].y,this.initialRpath3[10].y=this.rpath1[10].y;var S=BABYLON.MeshBuilder.CreateRibbon("rb",{pathArray:[this.rpath1,this.rpath2]},i);this.cockpit=BABYLON.Mesh.MergeMeshes([m,c,l,S],!0,!0),this.cockpit.alwaysSelectAsActiveMesh=!0,this.cockpit.material=SF.Materials.ship,this.cockpit.freezeWorldMatrix(),S=c=l=null,this.pathArray=[this.rpath3,this.rpath1],this.shieldMesh=BABYLON.MeshBuilder.CreateRibbon("sh",{pathArray:this.pathArray,updatable:!0},i),this.shieldMesh.material=SF.Materials.shield,this.shieldMesh.freezeWorldMatrix(),this.shieldMesh.alwaysSelectAsActiveMesh=!0,this.maxShield=e.maxShield,this.shield=this.maxShield},SF.Starship.prototype.resetShield=function(){this.shield=this.maxShield,SF.Materials.shield.diffuseColor.r=0,SF.Materials.shield.diffuseColor.g=1,SF.Materials.shield.alpha=.5;for(var e=0;e<this.initialRpath3.length;e++)this.rpath3[e].copyFrom(this.initialRpath3[e]);BABYLON.MeshBuilder.CreateRibbon(null,{pathArray:this.pathArray,instance:this.shieldMesh})},SF.Starship.prototype.checkLaserHit=function(e){if(e.position.x<this.cockpitArea.x&&e.position.x>-this.cockpitArea.x&&e.position.y<this.cockpitArea.y&&e.position.y>-this.cockpitArea.y){var i=.3*(Math.random()-.5);this.gameScene.bumpCamera(i),this.updateShield(Math.abs(i)),this.shield<0&&(this.gameScene.alive=!1,window.confirm("You're dead...\n\nSCORE = "+this.gameScene.score+"\n\nRetry ?\n\n")&&(this.resetShield(),this.gameScene.alive=!0,this.gameScene.score=0,this.gameScene.gui.score.text=this.gameScene.gui.pad(this.gameScene.score,6)))}},SF.Starship.prototype.shakeCockpit=function(){},SF.Starship.prototype.updateShield=function(e){this.shield-=e,SF.Materials.shield.diffuseColor.g-=e/this.shield*.8,SF.Materials.shield.diffuseColor.r+=e/this.shield*.8,SF.Materials.shield.alpha+=e/this.shield*.5;for(var i=1;i<this.rpath3.length-1|0;i++)this.rpath3[i].y-=this.cockpitHeight/2*(e/this.shield);BABYLON.MeshBuilder.CreateRibbon(null,{pathArray:this.pathArray,instance:this.shieldMesh})},SF.Weapons=function(e){var i=e.scene,t=e.sightDistance,s=e.canLength,a=e.canRadius;this.gameScene=e,this.sight=BABYLON.MeshBuilder.CreatePlane("sight",{size:.2},i),this.sight.position=V(0,0,t),this.sight.material=SF.Materials.sight,this.sight.alwaysSelectAsActiveMesh=!0;var n=new BABYLON.Vector3(-1.5,-1,2.2),o=[V(0,0,0),V(0,0,.8*s),V(0,0,.8*s),V(0,0,s)],h=BABYLON.MeshBuilder.CreateTube("c0",{path:o,radiusFunction:function(e,i){var t=a;return 2==e&&(t*=1.25),3==e&&(t*=.8),t}},i);h.material=SF.Materials.ship,h.position=n;var r=h.createInstance("c1",i);r.position.x=-h.position.x;var c=h.createInstance("c2",i);c.position.y=-h.position.y;var l=h.createInstance("c3",i);l.position.y=c.position.y,l.position.x=r.position.x,h.alwaysSelectAsActiveMesh=!0,r.alwaysSelectAsActiveMesh=!0,c.alwaysSelectAsActiveMesh=!0,l.alwaysSelectAsActiveMesh=!0,this.cannons=[h,r,c,l],this.cannonDirections=[V(0,0,0),V(0,0,0),V(0,0,0),V(0,0,0)],this.cannonHeats=[0,0,0,0]},SF.Weapons.prototype.animate=function(){var e=this.gameScene;this.sight.position.x=e.pointerDistance.x*e.fovCorrection*e.aspectRatio,this.sight.position.y=e.pointerDistance.y*e.fovCorrection;for(var i=0;i<this.cannons.length;i++)this.sight.position.subtractToRef(this.cannons[i].position,this.cannonDirections[i]),this.cannons[i].rotation.y=Math.atan2(this.cannonDirections[i].x,this.cannonDirections[i].z),this.cannons[i].rotation.x=-Math.atan2(this.cannonDirections[i].y*Math.cos(this.cannons[i].rotation.y),this.cannonDirections[i].z),this.cannonHeats[i]>0|0&&this.cannonHeats[i]--},SF.Enemy=function(e,i,t){this.id=e,this.model=i,this.gameScene=t,this.enemyShield=this.gameScene.enemyShield,this.enemySpeed=this.gameScene.enemySpeed,this.maxShield=6|0+Math.random()*this.enemyShield,this.speed=this.enemySpeed*Math.random(),this.shield=this.maxShield,this.explosion=!1,this.mustRebuild=!1,this.randAng=V(Math.random(),Math.random(),Math.random()),this.initialParticlePositions=[],this.enemyExplosionVelocity=this.gameScene.enemyExplosionVelocity,this.initialAlpha=1.3;var s=this.gameScene.scene,a=new BABYLON.SolidParticleSystem("esps"+this.id,s);a.digest(this.model,{facetNb:12,delta:10}),a.buildMesh(),a.mesh.material=Math.random()<.5?SF.Materials.enemy1:SF.Materials.enemy2,a.mesh.hasVertexAlpha=!1,this.sps=a,this.mesh=a.mesh;for(var n=0;n<a.nbParticles;n++){var o=a.particles[n];this.initialParticlePositions.push(o.position.clone()),o.velocity.copyFrom(o.position),o.velocity.multiplyInPlace(this.randAng),o.velocity.scaleInPlace(this.enemyExplosionVelocity),o.uvs.z=.2,o.uvs.w=.08,o.color.a=this.initialAlpha,o._ind<300?(o.color.r=0,o.color.g=Math.random()<.5?0:.3,o.color.b=Math.random()<.5?0:.3):o._ind<876&&(o.color.r=.55,o.color.g=.5,o.color.b=.5)}a.setParticles(),a.refreshVisibleSize();var h=this;a.updateParticle=function(e){h.explosion&&(e.color.a<1&&(h.mesh.hasVertexAlpha=!0),e.position.addInPlace(e.velocity),e.rotation.x+=e.velocity.z*h.randAng.x,e.rotation.y+=e.velocity.x*h.randAng.y,e.rotation.z+=e.velocity.y*h.randAng.z,e.color.a-=.01,SF.Lights.explosionLight.intensity-=.001,SF.Lights.explosionLight.intensity<.001&&(SF.Lights.explosionLight.intensity=0),e.color.a<.8&&(h.mustRebuild=!0))},a.mesh.position.z=50+10*Math.random(),a.mesh.position.y=8*Math.random()-4,a.mesh.position.x=4*-this.gameScene.enemyNb+2*this.gameScene.enemyNb*this.id,a.mesh.rotation.z=Math.random()*this.id},SF.Enemy.prototype.shoot=function(){for(var e=!0,i=0,t=this.gameScene.enemyLasers.sps,s=t.particles;i<t.nbParticles&&e;)if(s[i].isVisible)i+=2;else for(var a=0;a<2|0;a++)s[i+a].isVisible=!0,s[i+a].position.copyFrom(this.mesh.position),this.mesh.position.scaleToRef(-1,s[i+a].velocity),s[i+a].velocity.normalize(),s[i+a].velocity.scaleInPlace(this.gameScene.enemyLasers.enemyLaserSpeed),s[i+a].color.copyFrom(this.gameScene.enemyLasers.enemyLaserInitialColor),s[i+a].rotation.z=this.gameScene.halfPI*a,e=!1},SF.Enemy.prototype.checkHit=function(e){var i=this.gameScene.aspectRatio,t=this.gameScene.bboxpc,s=this.mesh.position.z*this.gameScene.cameraFov,a=this.mesh.position.x/(s*i),n=this.mesh.position.y/s,o=this.mesh.getBoundingInfo().boundingBox,h=(o.maximumWorld.x-o.minimumWorld.x)*t*.5/(s*i),r=(o.maximumWorld.y-o.minimumWorld.y)*t*.5/s;if(e.screenTarget.x>=a-h&&e.screenTarget.x<=a+h&&e.screenTarget.y>=n-r&&e.screenTarget.y<=n+r){this.shield--;var c=this.gameScene.impacts.sps.particles[e.id];c.isVisible=!0,c.position.x=e.target.x,c.position.y=e.target.y,c.scaling.x=this.gameScene.distance/this.mesh.position.z*1.2,c.scaling.y=c.scaling.x,0===this.shield|0&&this.explode(c)}},SF.Enemy.prototype.explode=function(e){this.explosion=!0,e.scaling.x=60,e.position.copyFrom(this.mesh.position),this.gameScene.impacts.explosions[e.idx]=!0,SF.Lights.explosionLight.position.copyFrom(this.mesh.position),SF.Lights.explosionLight.intensity=SF.Lights.explLghtIntensity,this.gameScene.score+=100,this.gameScene.gui.score.text=this.gameScene.gui.pad(this.gameScene.score,6)},SF.Enemy.prototype.rebuild=function(){this.explosion=!1,this.mesh.hasVertexAlpha=!1,this.mustRebuild=!1,this.shield=this.maxShield;for(var e=0;e<this.sps.nbParticles;e++)this.sps.particles[e].position.copyFrom(this.initialParticlePositions[e]),this.sps.particles[e].color.a=this.initialAlpha,this.sps.particles[e].rotation.x=0,this.sps.particles[e].rotation.y=0,this.sps.particles[e].rotation.z=0,this.sps.particles[e].velocity.copyFrom(this.sps.particles[e].position),this.sps.particles[e].velocity.scaleInPlace(Math.random()*this.enemyExplosionVelocity);this.sps.setParticles()},SF.Enemies=function(e){this.gameScene=e,this.enemyNb=this.gameScene.enemyNb,this.enemyFireFrequency=this.gameScene.enemyFireFrequency,this.enemyFireLimit=this.gameScene.enemyFireLimit,this.pool=[];var i=this.gameScene.scene,t=BABYLON.MeshBuilder.CreateCylinder("",{height:.1,tessellation:16,diameter:3.2},i),s=BABYLON.MeshBuilder.CreateCylinder("",{height:.1,tessellation:16,diameter:3.2},i),a=BABYLON.MeshBuilder.CreateCylinder("",{diameter:.5,height:4,subdivisions:2},i),n=BABYLON.MeshBuilder.CreateSphere("",{diameter:2,segments:4},i),o=BABYLON.MeshBuilder.CreateSphere("",{segments:3,diameterX:1,diameterY:1,diameterZ:.2},i),h=BABYLON.MeshBuilder.CreateIcoSphere("",{radius:.5,subdivisions:6},i),r=BABYLON.MeshBuilder.CreateCylinder("",{height:1.4,diameterBottom:.2,diameterTop:.75,tessellation:16,subdivisions:1},i),c=r.clone(),l=r.clone(),m=r.clone();r.rotation.x=this.gameScene.halfPI,c.rotation.x=this.gameScene.halfPI,l.rotation.x=this.gameScene.halfPI,m.rotation.x=this.gameScene.halfPI,r.position.x=-.5,r.position.y=.5,r.position.z=.2,c.position.x=.5,c.position.y=.5,c.position.z=.2,l.position.y=-.5,l.position.z=.2,m.scaling.y=.9,m.scaling.z=.9,m.scaling.x=.9,a.rotation.z=this.gameScene.halfPI,t.rotation.z=this.gameScene.halfPI,s.rotation.z=-this.gameScene.halfPI,t.position.x=2,s.position.x=-2,o.position.z=-1;for(var p=BABYLON.Mesh.MergeMeshes([o,r,c,l,h,a,m,m,m,n,t,s],!0,!0),d=0;d<this.enemyNb;d++)this.pool[d]=new SF.Enemy(d,p,this.gameScene);p.dispose()},SF.Enemies.prototype.checkHit=function(e){for(var i=0;i<this.enemyNb;i++)this.pool[i].checkHit(e)},SF.Enemies.prototype.animate=function(){for(var e=0,i=0,t=0,s=1,a=0;a<this.enemyNb;a++){var n=this.pool[a];n.explosion?n.mustRebuild?(n.rebuild(),n.randAng.multiplyByFloats(Math.random(),Math.random(),Math.random())):n.sps.setParticles():(s=a%2==0?1:-1,t=1e-4*Date.now()*s*n.speed,e=(i=n.mesh.position.z*this.gameScene.cameraFov*2)*this.gameScene.aspectRatio,n.mesh.position.x<-e&&(n.mesh.position.x=-e),n.mesh.position.x>e&&(n.mesh.position.x=e),n.mesh.position.y<-i&&(n.mesh.position.y=-i),n.mesh.position.y>i&&(n.mesh.position.y=i),n.mesh.rotation.z+=Math.sin(t)/(10+5*a)*n.speed,n.mesh.rotation.y+=Math.sin(t)/(10+5*a)/8,n.mesh.position.z=this.gameScene.sightDistance+this.gameScene.distance*(1+Math.sin(t+a)),n.mesh.position.x+=Math.cos(t-a)/5,n.mesh.position.y+=Math.sin(t+a/2)/8),n.mesh.position.x-=this.gameScene.pointerDistance.x*n.mesh.position.z/this.gameScene.distance,n.mesh.position.y-=this.gameScene.pointerDistance.y*n.mesh.position.z/this.gameScene.distance,Math.random()<this.enemyFireFrequency&&n.mesh.position.z>this.enemyFireLimit&&!n.explosion&&n.shoot()}},SF.EnemyLasers=function(e){this.gameScene=e,this.enemyLaserNb=this.gameScene.enemyLaserNb,this.enemyLaserSpeed=this.gameScene.enemyLaserSpeed,this.enemyLaserInitialColor=this.gameScene.enemyLaserInitialColor,this.enemyFireFrequency=this.gameScene.enemyFireFrequency,this.enemyFireLimit=this.gameScene.enemyFireLimit;var i=this.gameScene.scene,t=BABYLON.MeshBuilder.CreatePlane("elm",{size:.2},i),s=new BABYLON.SolidParticleSystem("elsps",i);s.addShape(t,this.enemyLaserNb),s.buildMesh(),this.sps=s,this.mesh=s.mesh,s.mesh.material=SF.Materials.star;for(var a=0;a<this.enemyLaserNb;a++){var n=s.particles[a];n.isVisible=!1,n.color.copyFrom(this.enemyLaserInitialColor)}s.setParticles(),s.isAlwaysVisible=!0,s.computeParticleTexture=!1;var o=this.gameScene.pointerDistance,h=this.gameScene.distance,r=this.gameScene.cockpitArea,c=this.gameScene.starship;s.updateParticle=function(e){e.isVisible&&(e.position.addInPlace(e.velocity),e.position.x+=o.x*e.position.z*e.velocity.z/h,e.position.y+=o.y*e.position.z*e.velocity.z/h,e.rotation.z+=.66,e.scaling.x=2+r.z/e.position.z*4,e.scaling.y=4*e.scaling.x,e.color.a+=.005,e.color.r+=.01,e.color.g+=.01,e.color.a>.9&&(e.color.a=.9),e.color.r>1&&(e.color.r=1),e.color.g<0&&(e.color.g=0),e.position.z<r.z&&(e.isVisible=!1,c.checkLaserHit(e)))}},SF.EnemyLasers.prototype.animate=function(){this.sps.setParticles()},SF.Stars=function(e){this.starNb=e.starNb,this.starEmitterSize=e.starEmitterSize,this.distance=e.distance,this.starZLimit=e.sightDistance,this.moderation=e.moderation,this.pointerDistance=e.pointerDistance,this.ang=e.ang,this.rotMatrix=e.rotMatrix,this.speedVector=e.speedVector,this.tmpSpeed=e.tmpSpeed,this.canvas=e.canvas,this.material=SF.Materials.star;var i=e.scene,t=new BABYLON.SolidParticleSystem("stars",i),s=BABYLON.MeshBuilder.CreatePlane("p",{size:.2},i);t.addShape(s,this.starNb),s.dispose(),t.buildMesh(),this.sps=t,this.mesh=this.sps.mesh,t.mesh.material=this.material,t.mesh.hasVertexAlpha=!0,t.mesh.freezeNormals(),t.mesh.freezeWorldMatrix(),t.isAlwaysVisible=!0,t.computeParticleRotation=!1,t.computeParticleTexture=!1;for(var a=t.particles,n=0;n<this.starNb;n++)a[n].position.x=this.starEmitterSize*(Math.random()-.5),a[n].position.y=this.starEmitterSize*(Math.random()-.5),a[n].position.z=this.distance*Math.random(),a[n].velocity.z=1.1-.2*Math.random();t.setParticles();var o=this.distance,h=this.starZLimit,r=this.starEmitterSize,c=this.pointerDistance,l=this.canvas,m=this.ang,p=1/this.moderation,d=this.rotMatrix,S=this.speedVector,g=this.tmpSpeed;t.beforeUpdateParticles=function(){i.pointerX&&(c.x=2*i.pointerX/l.width-1,m.y=Math.atan(c.x)),i.pointerY&&(c.y=1-2*i.pointerY/l.height,m.x=Math.atan(c.y)),BABYLON.Matrix.RotationYawPitchRollToRef(m.y*p,m.x*p,0,d),BABYLON.Vector3.TransformCoordinatesToRef(S,d,g)},t.updateParticle=function(e){e.position.addInPlace(g),e.position.x-=c.x*e.position.z*e.velocity.z/o,e.position.y-=c.y*e.position.z*e.velocity.z/o,e.position.z<h&&(e.position.z=o*(1-.25*Math.random()),e.position.x=r*(Math.random()-.5)+o*c.x*.5,e.position.y=r*(Math.random()-.5)+o*c.y*.5,e.scaling.x=1.1-.2*Math.random(),e.scaling.y=e.scaling.x,e.velocity.z=1.1-.2*Math.random())}},SF.Stars.prototype.animate=function(){this.sps.setParticles()},SF.LogicalLaser=function(e,i){this.id=i,this.mesh=e.particles[i],this.target=V(0,0,0),this.direction=V(0,0,0),this.fired=!1,this.cannon=0,this.scaling=0,this.screenTarget=BABYLON.Vector2.Zero()},SF.ShipLasers=function(e){this.gameScene=e;var i=this.gameScene.scene;this.distance=this.gameScene.distance,this.canRadius=this.gameScene.canRadius,this.canLength=this.gameScene.canLength,this.laserNb=this.gameScene.laserNb,this.laserSpeed=this.gameScene.laserSpeed,this.ballRadius=8*this.canRadius,this.ballPos=V(0,0,0),this.targetAxis=V(0,0,0),this.axis2=V(0,0,0),this.axis3=V(0,0,0),this.fired=!1,this.cannons=this.gameScene.weapons.cannons,this.cannonHeats=this.gameScene.weapons.cannonHeats,this.cannonDirections=this.gameScene.weapons.cannonDirections,this.fireHeat=this.gameScene.fireHeat,this.pointerDistance=this.gameScene.pointerDistance,this.sight=this.gameScene.weapons.sight,this.camera=this.gameScene.camera,this.fovCorrection=this.gameScene.fovCorrection,this.laserLightInitialColor=this.gameScene.laserLightInitialColor,this.lightDistance=this.gameScene.lightDistance,this.ballFovCorrection=this.gameScene.ballFovCorrection;var t=[2*-this.canRadius,-1,0,2*this.canRadius,-1,0,0,0,0],s=[0,1,2],a=[];BABYLON.VertexData.ComputeNormals(t,s,a);var n=new BABYLON.VertexData;n.positions=t,n.indices=s,n.normals=a,n.colors=[1,1,1,1,1,1,1,1,0,0,1,1];var o=new BABYLON.Mesh("l",i);n.applyToMesh(o);var h=BABYLON.MeshBuilder.CreateDisc("lb",{radius:1,tessellation:24,updatable:!0},i),r=new Float32Array(108);r[0]=.5,r[1]=.5,r[2]=1,r[3]=.8;for(var c=1;c<27;c++)r[4*c|0]=.5,r[1|4*c]=.5,r[2|4*c]=1,r[3|4*c]=.7;h.setVerticesData(BABYLON.VertexBuffer.ColorKind,r);var l=new BABYLON.SolidParticleSystem("lsps",i);l.addShape(o,this.laserNb),l.addShape(h,this.laserNb),l.buildMesh(),o.dispose(),h.dispose(),l.isAlwaysVisible=!0,l.computeParticleColor=!1,l.computeParticleTexture=!1,l.mesh.hasVertexAlpha=!0,l.mesh.material=SF.Materials.laser;var m=BABYLON.MeshBuilder.CreatePlane("llmd",{size:.2},i),p=new BABYLON.SolidParticleSystem("llsps",i);p.addShape(m,this.laserNb),p.buildMesh(),m.dispose(),p.isAlwaysVisible=!0,p.computeParticleTexture=!1,p.mesh.hasVertexAlpha=!0,p.mesh.material=SF.Materials.star;for(var d=0;d<this.laserNb;d++){var S=p.particles[d];S.isVisible=!1,S.position.z=this.lightDistance,S.velocity.z=.5,S.color.copyFrom(this.laserLightInitialColor),S.scaling.x=this.distance/this.lightDistance*1.2,S.scaling.y=S.scaling.x}p.setParticles();var g,u,y=this.pointerDistance,L=this.distance;p.updateParticle=function(e){e.isVisible&&(e.position.z+=e.velocity.z,e.position.x-=y.x*e.position.z*e.velocity.z/L,e.position.y-=y.y*e.position.z*e.velocity.z/L,e.position.z>L&&(e.isVisible=!1))};for(var x=[],B=0;B<2*this.laserNb|0;B++)(g=new SF.LogicalLaser(l,B)).mesh.isVisible=!1,g.mesh.scaling.y=0,g.mesh.scaling.x=0,g.mesh.position.z=this.sightDistance,x.push(g);var f=this.laserNb,M=this.laserSpeed,v=this.canLength,A=this.ballPos,F=this.cannons;e=this.gameScene;l.updateParticle=function(i){i.isVisible&&i.idx<f&&(g=x[i.idx],u=x[i.idx+f],i.scaling.y*=M,i.scaling.x*=M,u.mesh.scaling.x*=M,u.mesh.scaling.x<.02?u.mesh.scaling.x=0:(g.direction.scaleToRef(v+.03*(1-.5*Math.random())/i.scaling.x,A),u.mesh.position.copyFrom(A.addInPlace(F[g.cannon].position))),u.mesh.scaling.y=u.mesh.scaling.x,i.scaling.y<=.01&&(i.scaling.y=0,g.fired=!1,u.fired=!1,i.isVisible=!1,e.enemies.checkHit(g)))},this.pool=x,this.sps=l,this.laserLightSPS=p,this.mesh=l.mesh},SF.ShipLasers.prototype.animate=function(){var e=0,i=!0,t=0|4*Math.random(),s=SF.Lights.pointLight;if(s.intensity-=.1,s.intensity<0&&(s.intensity=0),this.fired&&0==this.cannonHeats[t]|0)for(this.cannonHeats[t]=this.fireHeat;e<this.laserNb&&i;){var a=this.pool[e],n=this.pool[e+this.laserNb],o=this.laserLightSPS.particles;if(a.fired)e++;else{this.starNb;a.fired=!0,a.mesh.isVisible=!0,n.mesh.isVisible=!0,a.cannon=t,n.cannon=t,a.screenTarget.copyFromFloats(this.pointerDistance.x,this.pointerDistance.y),a.target.copyFrom(this.sight.position),a.direction.copyFrom(this.cannonDirections[t]),a.scaling=a.direction.length(),a.direction.normalize(),a.mesh.position.copyFrom(a.target),a.target.subtractToRef(this.camera.position,this.targetAxis),BABYLON.Vector3.CrossToRef(a.direction,this.targetAxis,this.axis3),BABYLON.Vector3.CrossToRef(this.targetAxis,this.axis3,this.axis2),BABYLON.Vector3.RotationFromAxisToRef(this.axis3,this.axis2,this.targetAxis,a.mesh.rotation),a.mesh.scaling.y=a.scaling*this.fovCorrection/this.laserSpeed,a.mesh.scaling.x=1,n.mesh.scaling.x=this.ballRadius*(1.2-.8*Math.random()),n.mesh.scaling.y=n.mesh.scaling.x,a.direction.scaleToRef(this.canLength+.05*Math.random(),this.ballPos),n.mesh.position.copyFrom(this.ballPos.addInPlace(this.cannons[t].position)),o[e].isVisible=!0,o[e].position.x=this.pointerDistance.x*this.ballFovCorrection*this.gameScene.aspectRatio,o[e].position.y=this.pointerDistance.y*this.ballFovCorrection,o[e].position.z=this.lightDistance,s.position.copyFrom(n.mesh.position),s.intensity=SF.Lights.pointLightMaxIntensity,i=!1}}this.sps.setParticles(),this.laserLightSPS.setParticles()},SF.Impacts=function(e){this.gameScene=e,this.impactNb=this.gameScene.laserNb,this.impactInitialColor=this.gameScene.impactInitialColor,this.explosionInitialColor=this.gameScene.explosionInitialColor,this.explosions=[];var i=this.gameScene.scene,t=BABYLON.MeshBuilder.CreatePlane("imdl",{size:.2},i),s=new BABYLON.SolidParticleSystem("isps",i);s.addShape(t,this.impactNb),s.buildMesh(),t.dispose();for(var a=0;a<s.nbParticles;a++)s.particles[a].isVisible=!1,s.particles[a].position.z=this.gameScene.sightDistance,s.particles[a].color.copyFrom(this.impactInitialColor),this.explosions.push(!1);s.setParticles(),s.mesh.freezeNormals(),s.isAlwaysVisible=!0,s.mesh.hasVertexAlpha=!0,s.computeParticleRotation=!1,s.computeParticleTexture=!1,s.mesh.material=SF.Materials.impact,this.sps=s,this.mesh=this.sps.mesh;var n=this.impactInitialColor,o=this.explosions;e=this.gameScene;s.updateParticle=function(i){i.isVisible&&(i.position.x-=e.pointerDistance.x*i.position.z/e.distance,i.position.y-=e.pointerDistance.y*i.position.z/e.distance,o[i.idx]?(i.scaling.x*=1+.5*Math.random(),i.scaling.y=i.scaling.x/(1.1+Math.random()),i.color.r=e.explosionInitialColor.r-.1*Math.random(),i.color.g=e.explosionInitialColor.g-.1*Math.random(),i.color.b=e.explosionInitialColor.b,i.color.a-=.07,i.color.a<.01&&(i.isVisible=!1,i.position.z=e.sightDistance,i.color.copyFrom(n),o[i.idx]=!1)):(i.color.a-=.01,i.scaling.x-=.1,i.scaling.y=i.scaling.x,i.scaling.x<.01&&(i.isVisible=!1,i.color.copyFrom(n))))}},SF.Impacts.prototype.animate=function(){this.sps.setParticles()},SF.GameScene=function(e,i){this.starNb=150,this.distance=60,this.starSpeed=1,this.starEmitterSize=this.distance/1.2,this.maxPlanetNb=5,this.sightDistance=5,this.canLength=.4,this.canRadius=.04,this.maxShield=6,this.laserNb=12,this.laserSpeed=.52,this.fireHeat=15,this.cockpitArea=V(1,1,2.5),this.cockpitHeight=.14,this.laserLightInitialColor=new BABYLON.Color4(.4,.4,1,.8),this.enemyNb=10,this.enemySpeed=3,this.enemyExplosionVelocity=1.15,this.enemyLaserNb=60,this.enemyLaserSpeed=2,this.enemyShield=8,this.enemyFireFrequency=.15,this.enemyFireLimit=4*this.sightDistance,this.enemyLaserInitialColor=new BABYLON.Color4(.8,0,0,.5),this.impactInitialColor=new BABYLON.Color4(.6,.6,1,.85),this.explosionInitialColor=new BABYLON.Color4(1,1,0,1),this.bboxpc=.75,this.ouchX=!1,this.ouchY=!1,this.ouchZ=!1,this.camToLeft=!1,this.tmpCam=V(0,0,0),this.camShakeSpeed=.01,this.camRestoreSpeed=.008,this.returnCamX=!1,this.returnCamY=!1,this.returnCamZ=!1,this.canvas=e,this.scene=null,this.camera=null,this.engine=i,this.alive=!0,this.score=0,this.cameraFov=0,this.fovCorrection=0,this.aspectRatio=0,this.halfPI=.5*Math.PI,this.lightDistance=.66*this.distance,this.ballFovCorrection=0,this.rotMatrix=BABYLON.Matrix.Zero(),this.quaternion=BABYLON.Quaternion.Zero(),this.ang=BABYLON.Vector2.Zero(),this.moderation=6,this.pointerDistance=BABYLON.Vector2.Zero(),this.speedVector=V(0,0,-this.starSpeed),this.tmpSpeed=V(0,0,0),this.canPos=new BABYLON.Vector3(-1.5,-1,2.2),this.angShift=Math.atan(this.canPos.y/this.distance),this.keyboard=[],this.pressedPointer=[],this.keys={CTRL:17,SHIFT:16},this.pointer={left:!1};var t=this.keyboard,s=this.pointer,a=this.keys;function n(e,i){e.keyCode==a.CTRL&&(t[a.CTRL]=i),e.keyCode==a.SHIFT&&(t[a.SHIFT]=i),0===e.button&&(s.left=i)}var o=new BABYLON.Scene(i);o.clearColor=BABYLON.Color3.Black(),this.scene=o,o.onKeyboardObservable.add(function(e){n(e.event,!0)},BABYLON.KeyboardEventTypes.KEYDOWN),o.onKeyboardObservable.add(function(e){n(e.event,!1)},BABYLON.KeyboardEventTypes.KEYUP),o.onPointerObservable.add(function(e){n(e.event,!0)},BABYLON.PointerEventTypes.POINTERDOWN),o.onPointerObservable.add(function(e){n(e.event,!1)},BABYLON.PointerEventTypes.POINTERUP);var h=new BABYLON.TargetCamera("camera",V(0,0,0),o);h.direction=V(0,0,1),this.cameraFov=Math.tan(.5*h.fov),this.camera=h,this.fovCorrection=this.cameraFov*this.sightDistance,this.aspectRatio=i.getAspectRatio(h),this.ballFovCorrection=this.cameraFov*this.lightDistance,this.gui=new SF.GUI(o),SF.CreateLights(o);var r=SF.Lights.light;this.light=r,this.initialSpaceLightDirection=SF.Lights.spaceLight.direction.clone(),SF.CreateMaterials(o),this.universe=new SF.Universe(this),r.excludedMeshes=[this.universe.mesh],SF.Lights.pointLight.excludedMeshes=[this.universe.mesh],SF.Lights.explosionLight.excludedMeshes=[this.universe.mesh],SF.Lights.spaceLight.excludedMeshes=[this.universe.mesh];var c=1+Math.floor(this.maxPlanetNb*Math.random());this.planets=new SF.Planets(this,c),r.excludedMeshes.push(this.planets.mesh),SF.Lights.pointLight.excludedMeshes.push(this.planets.mesh),SF.Lights.explosionLight.excludedMeshes.push(this.planets.mesh),this.starship=new SF.Starship(this),this.weapons=new SF.Weapons(this),SF.Lights.spaceLight.excludedMeshes.push(this.weapons.sight),this.shipLasers=new SF.ShipLasers(this),r.excludedMeshes.push(this.shipLasers.mesh),r.excludedMeshes.push(this.shipLasers.laserLightSPS.mesh),SF.Lights.spaceLight.excludedMeshes.push(this.shipLasers.laserLightSPS.mesh),this.stars=new SF.Stars(this),r.excludedMeshes.push(this.stars.mesh),SF.Lights.spaceLight.excludedMeshes.push(this.stars.mesh),this.enemies=new SF.Enemies(this),this.enemyLasers=new SF.EnemyLasers(this),r.excludedMeshes.push(this.enemyLasers.mesh),SF.Lights.spaceLight.excludedMeshes.push(this.enemyLasers.mesh),this.impacts=new SF.Impacts(this),r.excludedMeshes.push(this.impacts.mesh),SF.Lights.spaceLight.excludedMeshes.push(this.impacts.mesh);var l=this;o.registerBeforeRender(function(){l.alive&&(l.setCamera(),l.getInputs(),l.stars.animate(),l.universe.animate(),l.planets.animate(),l.weapons.animate(),l.shipLasers.animate(),l.enemies.animate(),l.enemyLasers.animate(),l.impacts.animate())})},SF.GameScene.prototype.getInputs=function(){this.shipLasers.fired=!(!this.keyboard[this.keys.SHIFT]&&!this.pointer.left)},SF.GameScene.prototype.setCamera=function(){this.aspectRatio=this.engine.getAspectRatio(this.camera),this.light.diffuse.b+=.1,this.light.diffuse.g+=.1,this.light.intensity-=.01,this.light.diffuse.b>1&&(this.light.diffuse.b=1),this.light.diffuse.g>1&&(this.light.diffuse.g=1),this.light.intensity<SF.Lights.lightInitialIntensity&&(this.light.intensity=SF.Lights.lightInitialIntensity),this.ouchY&&(this.camera.position.y<this.tmpCam.y&&!this.returnCamY?this.camera.position.y+=this.camShakeSpeed:(this.camera.position.y-=this.camRestoreSpeed,this.returnCamY=!0,this.camera.position.y<=0&&(this.camera.position.y=0,this.ouchY=!1,this.returnCamY=!1))),this.ouchZ&&(this.camera.position.z>this.tmpCam.z&&!this.returnCamZ?this.camera.position.z-=this.camShakeSpeed:(this.camera.position.z+=this.camRestoreSpeed,this.returnCamZ=!0,this.camera.position.z>=0&&(this.camera.position.z=0,this.ouchZ=!1,this.returnCamZ=!1))),this.ouchX&&(this.camToLeft?this.camera.position.x>this.tmpCam.x&&!this.returnCamX?this.camera.position.x-=this.camShakeSpeed:(this.camera.position.x+=this.camRestoreSpeed,this.returnCamX=!0):this.camera.position.x<this.tmpCam.x&&!this.returnCamX?this.camera.position.x+=this.camShakeSpeed:(this.camera.position.x-=this.camRestoreSpeed,this.returnCamX=!0),Math.abs(this.camera.position.x)<this.camRestoreSpeed&&this.returnCamX&&(this.camera.position.x=0,this.ouchX=!1,this.returnCamX=!1))},SF.GameScene.prototype.bumpCamera=function(e){this.tmpCam.copyFromFloats(e,.1*Math.random(),.1*-Math.random()),this.ouchX=!0,this.ouchY=!0,this.ouchZ=!0,this.camToLeft=!1,this.returnCamX=!1,this.returnCamY=!1,this.returnCamZ=!1,this.tmpCam.x<0&&(this.camToLeft=!0),this.light.diffuse.b=0,this.light.diffuse.g=.5,this.light.intensity=1},SF.MessageScene=function(e){this.scene=new BABYLON.Scene(e),this.text="";var i=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("TextScreen",!0,this.scene);i.idealWitdh=600,i.renderAtIdealSize=!0;var t=new BABYLON.GUI.TextBlock;t.text=this.text,t.color="white",t.fontSize=24,t.textVerticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP,i.addControl(t),this.textBlock=t},SF.MessageScene.prototype.setHTMLText=function(e){this.text=e,this.textBlock.text=this.text},SF.SceneManager=function(){this.scenes={},this.sceneNb=0,this.currentScene=void 0},SF.SceneManager.prototype.addScene=function(e,i){this.scenes[e]=i,0==this.sceneNb&&(this.currentScene=i),this.sceneNb++},SF.SceneManager.prototype.removeScene=function(e){this.scene[e]=null,this.sceneNb--,this.sceneNb<0&&(this.sceneNb=0,this.currentScene=null)},SF.SceneManager.prototype.renderCurrentScene=function(){this.currentScene.render()};var init=function(e){var i=document.querySelector("#renderCanvas"),t=new BABYLON.Engine(i,!0),s=new e.SceneManager,a=new e.GameScene(i,t);s.addScene("level",a.scene),console.log(s),window.addEventListener("resize",function(){t.resize()});var n=!0,o=1,h=0,r=0;t.runRenderLoop(function(){var e,i,t,a,c,l,m,p;s.renderCurrentScene(),o++,n&&(240==o&&(h=performance.now()),o>1200&&(r=performance.now(),n=!1,e="http://officegames.eu/logstat.php",i=h,t=r,a=960,c="5466527",l=Math.round(a/(t-i)*1e3),m="fps="+l+"&res="+window.innerWidth+"x"+window.innerHeight+"&code="+c+"&game=SF",(p=new XMLHttpRequest).open("POST",e,!0),p.setRequestHeader("Content-type","application/x-www-form-urlencoded"),p.send(m),console.log("stats logged : "+l+" fps, thank you.")))})};